<app-main-layout
  [userRole]="userRole"
  [sidenavCollapsed]="sidenavCollapsed"
  [breadcrumbItems]="breadcrumbItems"
  (sidenavToggle)="onSidenavToggle($event)"
  (fullscreenToggle)="toggleFullscreen()"
  (logoutEvent)="logout()"
>
  <div class="customers-container">
  <!-- Customers Table -->
  <div class="table-container">
    <div class="table-header">
      <div class="table-actions">
        <div class="search-section">
          <input 
            type="text" 
            placeholder="Search customers..." 
            class="search-input"
            (input)="filterCustomers($event)"
          />
          <button class="btn-danger" (click)="deleteSelected()" [disabled]="selectedCustomers.length === 0">
            <i class="fas fa-trash"></i> Delete Selected
          </button>
        </div>
        <div class="header-actions">
          <button type="button" class="btn-primary" (click)="openCreateCustomerModal()">
            <i class="fas fa-plus"></i> Create Customer
          </button>
          <button type="button" class="btn-secondary" (click)="downloadTemplate()">
            <i class="fas fa-download"></i> Template
          </button>
          <label class="btn-upload">
            <i class="fas fa-upload"></i> Import Excel
            <input type="file" #excelFile accept=".xlsx,.xls" (change)="uploadExcel($event)" />
          </label>
        </div>
      </div>
    </div>

    <div class="table-wrapper">
      <table class="customers-table">
      <thead>
        <tr>
          <th>
            <input type="checkbox" (change)="selectAll($event)" [checked]="selectAllChecked" />
          </th>
          <th>Actions</th>
          <th>Customer Code</th>
          <th>Name</th>
          <th>Contact</th>
          <th>Alt Contact</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Duration</th>
          <th>Loan Amount</th>
          <th>File Charge</th>
          <th>Agent Fee</th>
          <th>EMI</th>
          <th>Advance Days</th>
          <th>Given Amount</th>
          <th>Agent Commission</th>
          <th>Status</th>
          <th>Loan Type</th>
          <th>Remark</th>
          <th>Customer ID</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let customer of filteredCustomers" [class.selected]="selectedCustomers.includes(customer.id)">
          <td>
            <input type="checkbox" [checked]="selectedCustomers.includes(customer.id)" (change)="toggleSelection(customer.id)" />
          </td>
          <td class="actions">
            <button class="btn-icon btn-edit" (click)="openEditCustomerModal(customer.id)" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon btn-delete" (click)="deleteCustomer(customer.id)" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </td>
          <td>{{ customer.customer_code }}</td>
          <td>{{ customer.name }}</td>
          <td>{{ customer.contact_no }}</td>
          <td>{{ customer.alt_contact_no || 'N/A' }}</td>
          <td>{{ customer.start_date | date:'shortDate' }}</td>
          <td>{{ customer.end_date | date:'shortDate' || 'N/A' }}</td>
          <td>{{ customer.loan_duration || 'N/A' }}</td>
          <td class="amount">₹ {{ customer.loan_amount | number }}</td>
          <td>{{ customer.file_charge || 'N/A' }}</td>
          <td>{{ customer.agent_fee || 'N/A' }}</td>
          <td>{{ customer.emi || 'N/A' }}</td>
          <td>{{ customer.advance_days || 'N/A' }}</td>
          <td class="amount">₹ {{ customer.amount_after_deduction || 'N/A' }}</td>
          <td>{{ customer.agent_commission || 'N/A' }}</td>
          <td>
            <span class="status-badge" [class.status-active]="customer.status === 'active'" [class.status-inactive]="customer.status === 'inactive'">
              {{ customer.status || 'active' }}
            </span>
          </td>
          <td>{{ customer.loan_type || 'Personal Loan' }}</td>
          <td>{{ customer.remark || 'N/A' }}</td>
          <td>{{ customer.customer_id || customer.id }}</td>

        </tr>
      </tbody>
    </table>
    </div>
  </div>
</div>
</app-main-layout>

<!-- Create Customer Modal -->
<div class="modal" [class.show]="showCreateModal">
  <div class="modal-content customer-modal-large">
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <i class="fas fa-user-plus"></i>
        </div>
        <div class="header-text">
          <h3>Create New Customer</h3>
          <p>Add a new customer to the system</p>
        </div>
      </div>
      <div class="header-actions">
        <button type="button" class="btn-secondary" (click)="closeCreateCustomerModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="submit" class="btn-primary" form="createCustomerForm">
          <i class="fas fa-save"></i> Create Customer
        </button>
      </div>
    </div>
    
    <form id="createCustomerForm" (submit)="createCustomer($event)" class="customer-form">
      <div class="form-content">
        <!-- Left Section - Photo Area -->
        <div class="photo-section">
          <div class="photo-container">
            <div class="photo-preview" *ngIf="photoPreviews && photoPreviews.length > 0; else noPhotoTemplate">
              <img [src]="photoPreviews[0]" alt="Customer Photo" class="main-photo" />
              <button type="button" class="remove-photo-btn" (click)="removePhoto(0)">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <ng-template #noPhotoTemplate>
              <div class="no-photo-placeholder">
                <i class="fas fa-camera"></i>
                <span>Customer Photo</span>
              </div>
            </ng-template>
          </div>
          
          <label class="photo-upload-btn" for="photoUpload">
            <i class="fas fa-upload"></i>
            <span>Upload Photo</span>
            <input type="file" id="photoUpload" name="customerphoto" accept="image/*" (change)="onPhotoUpload($event)" />
          </label>
          
          <p class="photo-help-text">Upload a clear photo of the customer</p>
        </div>

        <!-- Right Section - Form Fields -->
        <div class="form-section">
          <!-- Customer Information -->
          <div class="form-group-section">
            <h4 class="section-title">
              <i class="fas fa-user"></i> Customer Information
            </h4>
            <!-- Customer Code field removed - auto-generated by backend - Updated: 2024-10-05 -->
            <div class="form-grid">
              <div class="form-group">
                <label>Full Name *</label>
                <input type="text" name="name" [(ngModel)]="customerForm.name" required />
              </div>
              <div class="form-group">
                <label>Contact Number *</label>
                <input type="text" name="contact_no" [(ngModel)]="customerForm.contact_no" required />
              </div>
              <div class="form-group">
                <label>Alternative Contact</label>
                <input type="text" name="alt_contact_no" [(ngModel)]="customerForm.alt_contact_no" />
              </div>
            </div>
          </div>

          <!-- Loan Information -->
          <div class="form-group-section">
            <h4 class="section-title">
              <i class="fas fa-money-bill-wave"></i> Loan Information
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Start Date *</label>
                <input type="date" name="start_date" [(ngModel)]="customerForm.start_date" required />
              </div>
              <div class="form-group">
                <label>End Date</label>
                <input type="date" name="end_date" [(ngModel)]="customerForm.end_date" readonly />
              </div>
              <div class="form-group">
                <label>Loan Duration (months) *</label>
                <input type="number" name="loan_duration" [(ngModel)]="customerForm.loan_duration" required />
              </div>
              <div class="form-group">
                <label>Loan Amount *</label>
                <input type="number" name="loan_amount" step="0.01" [(ngModel)]="customerForm.loan_amount" required />
              </div>
              <div class="form-group">
                <label>File Charge</label>
                <input type="number" name="file_charge" step="0.01" [(ngModel)]="customerForm.file_charge" />
              </div>
              <div class="form-group">
                <label>Agent Fee</label>
                <input type="number" name="agent_fee" step="0.01" [(ngModel)]="customerForm.agent_fee" />
              </div>
              <div class="form-group">
                <label>EMI</label>
                <input type="number" name="emi" step="0.01" [(ngModel)]="customerForm.emi" />
              </div>
              <div class="form-group">
                <label>Advance Days</label>
                <input type="number" name="advance_days" [(ngModel)]="customerForm.advance_days" />
              </div>
              <div class="form-group">
                <label>Amount After Deduction</label>
                <input type="number" name="amount_after_deduction" step="0.01" [(ngModel)]="customerForm.amount_after_deduction" />
              </div>
              <div class="form-group">
                <label>Agent Commission</label>
                <input type="number" name="agent_commission" step="0.01" [(ngModel)]="customerForm.agent_commission" />
              </div>
              <div class="form-group">
                <label>Status</label>
                <select name="status" [(ngModel)]="customerForm.status">
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
              <div class="form-group">
                <label>Loan Type</label>
                <select name="loan_type" [(ngModel)]="customerForm.loan_type">
                  <option value="Personal Loan">Personal Loan</option>
                  <option value="Gold Loan">Gold Loan</option>
                  <option value="Business Loan">Business Loan</option>
                  <option value="Home Loan">Home Loan</option>
                  <option value="Education Loan">Education Loan</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Additional Information -->
          <div class="form-group-section">
            <h4 class="section-title">
              <i class="fas fa-file-alt"></i> Additional Information
            </h4>
            <div class="form-group full-width">
              <label>Remark</label>
              <textarea name="remark" rows="3" [(ngModel)]="customerForm.remark" placeholder="Enter any additional notes or remarks..."></textarea>
            </div>
            
            <!-- Customer Documents Section -->
            <div class="form-group full-width">
              <label>Customer Documents</label>
              <div class="document-upload-area">
                <input type="file" name="customerdocument" accept="image/*" multiple (change)="onDocumentUpload($event)" />
                <div class="document-preview" *ngIf="documentPreviews && documentPreviews.length > 0">
                  <div class="document-grid">
                    <div class="document-item" *ngFor="let doc of documentPreviews; let i = index">
                      <img [src]="doc" alt="Document Preview" class="document-photo" />
                      <button type="button" class="remove-btn" (click)="removeDocument(i)">×</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Edit Customer Modal -->
<div class="modal" [class.show]="showEditModal">
  <div class="modal-content customer-modal-large">
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <i class="fas fa-user-edit"></i>
        </div>
        <div class="header-text">
          <h3>Edit Customer</h3>
          <p>Update customer information and details</p>
        </div>
      </div>
      <div class="header-actions">
        <button type="button" class="btn-secondary" (click)="closeEditCustomerModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="submit" class="btn-primary" form="editCustomerForm">
          <i class="fas fa-save"></i> Update Customer
        </button>
      </div>
    </div>
    
    <form id="editCustomerForm" (submit)="updateCustomer($event)" class="customer-form">
      <div class="form-content">
        <!-- Left Section - Photo Area -->
        <div class="photo-section">
          <div class="photo-container">
            <div class="photo-preview" *ngIf="photoPreviews && photoPreviews.length > 0; else noPhotoTemplate">
              <img [src]="photoPreviews[0]" alt="Customer Photo" class="main-photo" />
              <button type="button" class="remove-photo-btn" (click)="removePhoto(0)">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <ng-template #noPhotoTemplate>
              <div class="no-photo-placeholder">
                <i class="fas fa-camera"></i>
                <span>Customer Photo</span>
              </div>
            </ng-template>
          </div>
          
          <label class="photo-upload-btn" for="photoUploadEdit">
            <i class="fas fa-upload"></i>
            <span>Upload Photo</span>
            <input type="file" id="photoUploadEdit" name="customerphoto" accept="image/*" (change)="onPhotoUpload($event)" />
          </label>
          
          <p class="photo-help-text">Upload a clear photo of the customer</p>
        </div>

        <!-- Right Section - Form Fields -->
        <div class="form-section">
          <!-- Customer Information -->
          <div class="form-group-section">
            <h4 class="section-title">
              <i class="fas fa-user"></i> Customer Information
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Customer Code (Read-only)</label>
                <div class="auto-generated-field">
                  <span class="auto-generated-text">{{ editForm.customer_code }}</span>
                  <i class="fas fa-lock"></i>
                </div>
              </div>
              <div class="form-group">
                <label>Full Name *</label>
                <input type="text" name="name" [(ngModel)]="editForm.name" required />
              </div>
              <div class="form-group">
                <label>Contact Number *</label>
                <input type="text" name="contact_no" [(ngModel)]="editForm.contact_no" required />
              </div>
              <div class="form-group">
                <label>Alternative Contact</label>
                <input type="text" name="alt_contact_no" [(ngModel)]="editForm.alt_contact_no" />
              </div>
            </div>
          </div>

          <!-- Loan Information -->
          <div class="form-group-section">
            <h4 class="section-title">
              <i class="fas fa-money-bill-wave"></i> Loan Information
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Start Date *</label>
                <input type="date" name="start_date" [(ngModel)]="editForm.start_date" required />
              </div>
              <div class="form-group">
                <label>End Date</label>
                <input type="date" name="end_date" [(ngModel)]="editForm.end_date" readonly />
              </div>
              <div class="form-group">
                <label>Loan Duration (months) *</label>
                <input type="number" name="loan_duration" [(ngModel)]="editForm.loan_duration" required />
              </div>
              <div class="form-group">
                <label>Loan Amount *</label>
                <input type="number" name="loan_amount" step="0.01" [(ngModel)]="editForm.loan_amount" required />
              </div>
              <div class="form-group">
                <label>File Charge</label>
                <input type="number" name="file_charge" step="0.01" [(ngModel)]="editForm.file_charge" />
              </div>
              <div class="form-group">
                <label>Agent Fee</label>
                <input type="number" name="agent_fee" step="0.01" [(ngModel)]="editForm.agent_fee" />
              </div>
              <div class="form-group">
                <label>EMI</label>
                <input type="number" name="emi" step="0.01" [(ngModel)]="editForm.emi" />
              </div>
              <div class="form-group">
                <label>Advance Days</label>
                <input type="number" name="advance_days" [(ngModel)]="editForm.advance_days" />
              </div>
              <div class="form-group">
                <label>Amount After Deduction</label>
                <input type="number" name="amount_after_deduction" step="0.01" [(ngModel)]="editForm.amount_after_deduction" />
              </div>
              <div class="form-group">
                <label>Agent Commission</label>
                <input type="number" name="agent_commission" step="0.01" [(ngModel)]="editForm.agent_commission" />
              </div>
              <div class="form-group">
                <label>Status</label>
                <select name="status" [(ngModel)]="editForm.status">
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
              <div class="form-group">
                <label>Loan Type</label>
                <select name="loan_type" [(ngModel)]="editForm.loan_type">
                  <option value="Personal Loan">Personal Loan</option>
                  <option value="Gold Loan">Gold Loan</option>
                  <option value="Business Loan">Business Loan</option>
                  <option value="Home Loan">Home Loan</option>
                  <option value="Education Loan">Education Loan</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Additional Information -->
          <div class="form-group-section">
            <h4 class="section-title">
              <i class="fas fa-file-alt"></i> Additional Information
            </h4>
            <div class="form-group full-width">
              <label>Remark</label>
              <textarea name="remark" rows="3" [(ngModel)]="editForm.remark" placeholder="Enter any additional notes or remarks..."></textarea>
            </div>
            
            <!-- Customer Documents Section -->
            <div class="form-group full-width">
              <label>Customer Documents</label>
              <div class="document-upload-area">
                <input type="file" name="customerdocument" accept="image/*" multiple (change)="onDocumentUpload($event)" />
                <div class="document-preview" *ngIf="documentPreviews && documentPreviews.length > 0">
                  <div class="document-grid">
                    <div class="document-item" *ngFor="let doc of documentPreviews; let i = index">
                      <img [src]="doc" alt="Document Preview" class="document-photo" />
                      <button type="button" class="remove-btn" (click)="removeDocument(i)">×</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
