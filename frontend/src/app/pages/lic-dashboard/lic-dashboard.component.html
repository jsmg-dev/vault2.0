<app-main-layout
  [userRole]="userRole"
  [sidenavCollapsed]="sidenavCollapsed"
  [breadcrumbItems]="breadcrumbItems"
  (sidenavToggle)="onSidenavToggle($event)"
  (fullscreenToggle)="toggleFullscreen()"
  (logoutEvent)="logout()"
>

  <div class="lic-dashboard-container">

    <!-- Loading State -->
    <div class="loading-container" *ngIf="isLoading">
      <div class="loading-spinner"></div>
      <p>{{ languageService.translate('lic.loading_dashboard') }}</p>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-content" *ngIf="!isLoading">
      
      <!-- Key Metrics Cards -->
      <div class="metrics-grid">
        <div class="metric-card total-policies">
          <div class="metric-icon">
            <i class="fas fa-shield-alt"></i>
          </div>
          <div class="metric-content">
            <h3>{{ dashboardData.totalPolicies }}</h3>
            <p>{{ languageService.translate('lic.total_policies') }}</p>
          </div>
        </div>

        <div class="metric-card active-policies">
          <div class="metric-icon">
            <i class="fas fa-heartbeat"></i>
          </div>
          <div class="metric-content">
            <h3>{{ dashboardData.activePolicies }}</h3>
            <p>{{ languageService.translate('lic.active_policies') }}</p>
          </div>
        </div>

        <div class="metric-card due-today">
          <div class="metric-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="metric-content">
            <h3>{{ dashboardData.policiesDueToday }}</h3>
            <p>{{ languageService.translate('lic.due_today') }}</p>
          </div>
        </div>

        <div class="metric-card due-month">
          <div class="metric-icon">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="metric-content">
            <h3>{{ dashboardData.policiesDueThisMonth }}</h3>
            <p>{{ languageService.translate('lic.due_this_month') }}</p>
          </div>
        </div>
      </div>

      <!-- Charts and Tables Row -->
      <div class="dashboard-row">
        
        <!-- Policy Status Chart -->
        <div class="chart-container">
          <div class="chart-header">
            <h3><i class="fas fa-chart-pie"></i> {{ languageService.translate('lic.policy_status_distribution') }}</h3>
          </div>
          <div class="chart-content">
            <div class="status-chart">
              <div class="status-item" *ngFor="let status of chartData.policyStatus">
                <div class="status-color" [style.background-color]="status.color"></div>
                <div class="status-info">
                  <span class="status-label">{{ status.label }}</span>
                  <span class="status-value">{{ status.value }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Policy Types Chart -->
        <div class="chart-container">
          <div class="chart-header">
            <h3><i class="fas fa-chart-bar"></i> {{ languageService.translate('lic.policy_types') }}</h3>
          </div>
          <div class="chart-content">
            <div class="types-chart">
              <div class="type-item" *ngFor="let type of chartData.policyTypes">
                <div class="type-bar">
                  <div class="type-fill" 
                       [style.width.%]="(type.value / dashboardData.totalPolicies) * 100"></div>
                </div>
                <div class="type-info">
                  <span class="type-label">{{ type.label }}</span>
                  <span class="type-value">{{ type.value }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tables Row -->
      <div class="dashboard-row">
        
        <!-- Premium Due Today -->
        <div class="table-container">
          <div class="table-header">
            <h3><i class="fas fa-clock"></i> {{ languageService.translate('lic.premium_due_today') }}</h3>
            <span class="badge due-badge">{{ dashboardData.policiesDueToday }}</span>
          </div>
          <div class="table-content">
            <div class="table-responsive">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>{{ languageService.translate('lic.policy_no') }}</th>
                    <th>{{ languageService.translate('lic.customer') }}</th>
                    <th>{{ languageService.translate('lic.premium') }}</th>
                    <th>{{ languageService.translate('lic.mobile') }}</th>
                    <th>{{ languageService.translate('lic.actions') }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let policy of dashboardData.premiumDueToday">
                    <td>{{ policy.policy_no }}</td>
                    <td>{{ policy.fullname }}</td>
                    <td class="amount">{{ formatCurrency(policy.premium) }}</td>
                    <td>{{ policy.mobile }}</td>
                    <td class="actions">
                      <button class="btn-icon btn-whatsapp" 
                              (click)="sendWhatsAppNotification(policy.id)"
                              [title]="languageService.translate('lic.send_whatsapp')">
                        <i class="fab fa-whatsapp"></i>
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="dashboardData.premiumDueToday.length === 0">
                    <td colspan="5" class="no-data">{{ languageService.translate('lic.no_policies_due_today') }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Recent Policies -->
        <div class="table-container">
          <div class="table-header">
            <h3><i class="fas fa-plus-circle"></i> {{ languageService.translate('lic.recent_policies') }}</h3>
          </div>
          <div class="table-content">
            <div class="table-responsive">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>{{ languageService.translate('lic.policy_no') }}</th>
                    <th>{{ languageService.translate('lic.customer') }}</th>
                    <th>{{ languageService.translate('lic.plan') }}</th>
                    <th>{{ languageService.translate('lic.status') }}</th>
                    <th>{{ languageService.translate('lic.created') }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let policy of dashboardData.recentPolicies">
                    <td>{{ policy.policy_no }}</td>
                    <td>{{ policy.fullname }}</td>
                    <td>{{ policy.plan_name }}</td>
                    <td>
                      <span class="status-badge" 
                            [class]="'status-' + (policy.status || 'active').toLowerCase()">
                        {{ policy.status || 'Active' }}
                      </span>
                    </td>
                    <td>{{ formatDate(policy.created_at) }}</td>
                  </tr>
                  <tr *ngIf="dashboardData.recentPolicies.length === 0">
                    <td colspan="5" class="no-data">{{ languageService.translate('lic.no_recent_policies') }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Monthly Premium Chart -->
      <div class="chart-container full-width">
        <div class="chart-header">
          <h3><i class="fas fa-chart-line"></i> {{ languageService.translate('lic.monthly_premium_collection') }}</h3>
        </div>
        <div class="chart-content">
          <div class="monthly-chart">
            <div class="chart-bars">
              <div class="chart-bar" *ngFor="let month of chartData.monthlyPremium">
                <div class="bar-container">
                  <div class="bar-fill" 
                       [style.height.%]="(month.premium / getMaxPremium()) * 100">
                  </div>
                </div>
                <div class="bar-label">{{ month.month }}</div>
                <div class="bar-value">{{ formatCurrency(month.premium) }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</app-main-layout>
